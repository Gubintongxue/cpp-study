上节课呢，给大家把这个zookeeper的这个客户端封装的这个类，

给大家功能介绍了一下啊，主要就是三个功能，一个是负责连接的啊，一个是负责创建znode的节点，一个是获取znode的节点的值呢？对不对哎？

其实就是这么简单啊。只不过我们说了那么多，

还是主要想给大家说一下，这里边儿方法所涉及的一些理论的知识啊。

能够呢，就是我们之前说的啊，不是说我项目中用ZK，你就得把ZK的源码研究一遍啊。

没有那个必要，对吧你？



你为什么在这个项目中用它？

它的作用都有是都有哪些？你用了它的哪些功能？

你不仅仅用了它，你还知道它的哪些东西？我知道多少说多少就行了。好吧啊，知知道多少说多少就行了。然后在面试中哎，如果发现每次这个知识点都被问到，

那么你下去总结一下就行，我们为什么要面试经验呢？对不对啊？那么也是不断的在去。积累知识不断的在增长，对吧啊？任何的东西都是一样的。那么这节课呢？我们主要给大家说一下它的这个应用啊，主要用在rpc的这个服务的。发布方跟调用方两个方面都得用一个要发布向zk发布服务，一个在zk上是不是查询服务啊？对，来我第一点先说啊，先说在这个rpc服务发布方服务发布方是不是在rpc provider这里边儿啊？

首先再跟我回忆一下啊。rpc provider在这里边儿。首先，你要发布一个服务。啊，你要作为一个rpc服务的节点啊。就是你先初始化框架啊，定一个rpc provider，然后在这里边通过provider的notify service。注册各种各样的服务对象，包括里边儿的服务方法，然后启动是不是这个？好了，那我们现在就在这个run方法里边，就是rpc provider里边啊。

就让同学们我写到最后，我发现我们这个框架的命名，其他都OK，其他都是mpr PC，唯独这个。啊rpc provider呃，用的是rpc provider，没有用mp rpc provider。我希望有这个。我希望我们同学为了保持一致，还是能够把它改成mpr PC啊。好，这是题外话，我们。不不纠结了，

在这个run方法就是run方法之前呢，我们已经把该向这个rpc provider上该注册的这个服务对象跟服务方法。该注册都已经注册完了。最终呢，都写在这个m杠service map表当中了。是不是啊？m杠service map表这里边儿呢？记录的是所有服务的名字啊，相应的service infer的第二个，这个成员变量啊，这里边儿的map表。这记录的都是方法的名字，是不是？好了，那么在这里边大家看。

再run run run往下走。往下走，你看我在这加了一段代码，在这加了一段代码。干嘛呢？把当前rpc节点上要发布的服务全部注册到zk上，让RP ccl and可以从zk上发现服务。好吧啊，你别不要把服务捂着，你不像zk上注册服务，别人永远发现不了你这儿运行了哪些服务？对不对啊？也就是浪费了，那么在这儿呢，大家看我先通过这个客户端类定了一个对象调用start，

这是连接谁呢？这是在连接。谁啊？这是在连接zk server呢，对吧啊？连接上了以后呢？那么之前给大家说呢啊？就是我们原生zk gland aph存档的一个问题，是不会自动发送心跳消息，实际上说的不对啊。呃，因为呢，我通过检测呢，我发现呢，这一这一句话说的不对，

我还。针对这句话，我还特意看了这个zk client API的这个源码啊。然后我发现呢，确实不是的，人家在它的这个网络l线程上会以三分之一的这个会话超时时间定期的发送聘包啊。p包这个p相当于就是一个心跳消息，应该是会发心跳消息的，在这里边儿我给大家注释出来了。啊，一会儿我给大家验证一下，通过抓包啊，通过我们的DC TCP Tom抓包，我们就可以清楚的看到这里边儿到底有没有？发送心跳消息。

好，先来看，在这里边。然后for循环for循环啊，先循环这个service map，那在这里边呢，通过service map的这个first也就是service name我们。可以组成这个斜杠service name，这一个zeno的节点路径先创建这个节点。相当于就是在这个zk上创建这个斜杠order service。这我给大家运运也运行了一些，你看相当于就是创建了这个friend service rpc。这就是你那个对象的这个名字。在你这个对象名字下边儿，要创建什么？

要创建方法的这个rpc方法的名字的嘛。对不对？我现在看它底下有没有？它底下没有，它底下现在没有方法，为什么呢？因为方法名字方法名字的这个z no的节点，我们创建的都是临时性节点。zk client和zk server断开的话，临时性节点就自动的被删除掉了，也应该删除嘛。你不能说zk这个服务呢，已经没有人提供了啊，你在这里边zk上还记录了这个服务所在的ipd的端口。别人要用根本连不上，

是不是啊？好，那么在这儿呢，先创建了，比如说在这里边儿就先创建了。user service.rpc好吧，然后再呢循环这个。service里边的这个method啊。然后再组织组织它的method pass，相当于在这里边就是user service。rpc斜杠。啊logan。就是这样的，就这样的pass创建这个pass。

创建这个pass的时候，我们要给这个login啊，这个服务方法的这个节点呢，要存数据存的是什么呀？存的就是它，就是当前当前这个rpc服务。啊，存储当前这个rpc服务节点。主机的IP和端口我们存的时候呢，也是用。IP冒号端口来存就行了好吧，所以在这里边儿调用了zk clamp的crit。啊，这是呢，这个路径，

那为什么你不不一下子创建这个呢？而要先创建这个节点再创建。先创建父节点，再创建父节点的子节点之前给大家说了嘛？啊z呢，仅仅支持一层一层节点创建。啊，不能说是父节点还没有呢，你就先创建子节点，它是创建不成功。好吧，在这里边儿，你看第二个参数是什么？第二个参数就是你这个节点呢？要放的这个数据。

然后呢？是什么？数据的长度，这是个什么意思啊？临时性结点好吧啊。服务的方法都是临时性节点。好不好啊？在这给大家注释一下吧。这是表示z node。它表示，那个z node是一个临时性。节点好吧，这也必须是临时性节点了，对不对啊？你是你是运行这个服务的好吧，

你是运行这个rpc服务的，你把这个服务注册到zk server上了。你现在跟zk server断了，也就是说你不再提供这个服务了，哎zk server上如果还保存你这个服务方法，那有人查的时候不是查到你的IP地址跟端口号儿了吗？那你都不运行了。你这zk是不是把别人骗了呀？所以当你挂掉的时候zk有责任去把你之前注册的这些节点都给它自动删掉，那你注册的时候呢，就把这些服务方法的节点。注册成临时性节点就可以了，非常方便，对不对？好，

那就这一课就完了，这个是不是就完了？在这儿呢，你看到后边儿这儿event loop，这就是阻塞当前的这个。线程我们作为一个服务器，是不是就启动了zk clan在这里边儿不会析构析构的话呢？就会跟这个zk server断开的。是不是断开的话呢？我们注册的这些服务方法zz k server就都会删掉，所以这里边儿呢不断开。啊，所以相当于这里边儿，我们自身是一个服务器，我们还保留了一条跟zk server的连接zk client的API，

人家自动会发送什么的。自动会发送这个pin消息，这个心跳消息维护和。和CK server的这个心跳啊。我们默认的这个timer的时间。就是session timer的时间是一个30秒。30秒，咱家的这个zk clan tapi啊API会。就是之前给大家说的啊zk zoo in it，人家会起一个线程，专门做网络IO操作嘛，对吧？网络连接成功以后呢？网络l线程大家专门会以三分之一。time out啊，

time out时间。时间哎，时间。发送聘。消息作为一个心跳消息来告诉呢zk server，我还在呢，我还在呢，你不要。session timeout不要session time，就是当我发送一个心跳消息到zk server的话，zk server会重新重置我这个zk client。一个绘画的超时时间，这之前也给大家讲过了。好吧啊OK，那么在这里边儿呢？

对于服务发布方在这里边儿所用到的zk功能就是这个。无非就是把服务发布上来嘛。服务发布上来，你看在这里边，我给大家运行一下啊。我给大家运行一下，那在这儿的话呢？你看在这儿，我运行以后，大家可以看到这相当于就是一些日志连接zk。server成功了，然后在这里边儿，你看z node create success a把这个呢？都创建成功了。是不是哎，

创建成功。在这儿呢，我用。它的这个。那我看一看，你看现在有没有了？现在是不是有了啊？get friend list，而我再获取一下这个节点的这个。数据看有没有啊？复制。粘贴啊，斜杠。大家看有吧，哎，

就表示呢，这个服务对象的服务方rpc服务方法在幺二七点零点零点一这台主机。记得8000多个号上呢，提供服务。那如果有人查的话，就来访问这个IP地址，跟这个端口号儿，你就能。远程调用这个rpc方法了。是不是啊？那么现在呢？相当于我就启动了一个什么呀？启动这个这消息，大家出现的话不用管啊。那相当于我就启动了一个rpc服务，

然后向这个zookeeper上呢发送了这个注册了，是不是相应的服务啊？在这里边，我给大家用。抓包工具呢，就是linux的TCP dom很好用啊。来验证一下，这里边儿有没有发送这个信条消息？呃TCP dump dump。在这里边，大家来看啊。因为我的这个zk client相当于我的这个rpc provider啊，跟zoo呢，都运行在一台主机上。所以我们抓这个。

本地还回的这个网卡啊。TCP du.omp杠哎。就是lo port是二幺八幺，就是专门抓二幺八幺这个端口上的这个。数据包啊，大家来看。哎，这又有消息了，是不是啊？再来看一组。再来拿一组我们。把它停掉啊，好了，那么大家看啊。

你们大家发现它间隔一段儿时间呢，就会发送消息，是不是像这个二幺八幺端口发消息对吧？你看这是。51秒。哎，零一秒是不是十秒的时间啊？绘画超时时间是30秒吗？你在这里边儿可以。看他协商的这个绘画实践呢。你看都是30秒好吧啊，在这里边儿呢。你会发现它每隔十秒钟呢。哎，这上面儿是零一。

这底下是一一，这上面是五一。每隔十秒钟就会发一次pin消息，这后边是这个给回复的啊。给回复的拼okay吧啊，所以这个呢？已经很好的验证了。人家这个zk的这个。API是会主动发。心跳消息我说了，它有三个线程，一个是调用API的线程，一个是。呃，网络l的线程在网络l线程里边儿，

人家专门会发送定定时就三分之一的timer的时间呢。时间啊，发送这个pin的这个心跳消息好吧啊，发送pin的这个信。新条消息。来保持呢和zk server的通信是畅通的，否则呢，你不发心跳不发心跳的话zk server。呃，一看诶30秒你都没有跟我交互，那我就认认定你断了，你断了的话呢？那zk server就会把你注册的所有的。服务方法就全部都删除掉。好吧啊，

别人也就发现。这是呢，我们在。lpc服务的发布方这一段所添加的。代码就这一段啊，然后是调用方，那就是在mpr PC channel点CC里边。大家来看一下啊，我先把这个。都断一下啊。都断一下，大家来看这块儿啊。这是我们。调用方对吧？2p的调用方调用方在这里边调用一个通过这个装类stub这个。

装备啊，也就代理对象调用方法的时候都跑到rpc channel的call method的方法里边来。在这里边儿获取参数对吧？打包参数，序列化参数。是要把这个参数呢？啊，组织组装好以后是不是要发到这个？放到哪里呀？发到rpc。这个提供方是不是去执行rpc方法啊？那你怎么知道这个rpc方法在哪里呢？而我知道这个我要调用的rpc方法，所它的service name跟method name，那我就拿这两个东西去zk上去查一下。

好，大家来看啊。原来我们代码呢？呃，再去这个连接rpc server的时候呢，直接是从配置文件读的是。实际上，我并不需要我们把这两个代码。啊，在这儿呢，我定义一个zk client。连接zk server。组装zero的节点路径就是相当于就是斜杠user service 2 PC。哎，在这里边儿相当于就是斜杠user service rpc斜杠log。

哎，这么一个zero的这个节点路径好吧啊，然后呢，调用它的get data。好获取回来的，这个是不是相当于就是幺二？七点零点零点一。8000，因为我们刚才在z nod上存储的这个数据就是这样的格式。然后这里边儿是一些出错信息，然后OK的话呢，我们就以这个冒号儿作为分隔啊，分隔把IP跟动括号儿分别拿出来。好不好啊？分别拿出来了，

以后呢？那后边儿代码就没有变了嘛，我们只是把IP跟port从原来的配置文件。读取现在呢，从zk上。发现就行了，也就是说增加的代码就是这一块。这个业务在这儿应该能明白吧？对，就是从zk上。啊，我现在调用服务方法了，但是我不知道这个服务方法呢？到底在哪里？那所有的服务方法都是在zk上注册的，

对不对啊？那我在这里边儿呢。通过组装好，通过service name跟method name组装好，那服务的这个z no的节点的路径，然后在zk上去。OK了吧哎，查一下查一下呢，在这里边儿。就okay啦。实际上就改这么点儿。rpc channel这里边。从这个上查服务的所在的rpc节点的IP地址端口号。rpc提服务提供方在这里边呢，启动的时候呢？

map里边所注册的所有的服务。对象跟服务方法的名字啊。注册到zk上。好吧，哎，就是这么一个逻辑。那么在这儿，你整个儿的去编译一下啊。编译，完成以后，我们在这儿，大家来看。啊，我启动。provider好吧啊，

provider。然后呢？在这儿呢？我怎么样啊？大家来看啊，这儿我执行一下consumer好吧啊，执行一下consumer点杠。consumer然后是杠I。这是一些日志连接zk server的。你定位很正常吧？定魂OK吧哎，定魂OK那在这里边儿也就是说呢？我们zk client是完全。是没有问题的啊，没有问题的，

我们rpc调用方呢，也是可以从zk上去找到它想调用的服务。我在的rpc节点的这个IP地址端口号，你看。这个也接触到请求了，现在就是。呃，consumer跟provider它是它们实际上它俩是没有直接去通信的好吧，它俩没有直接去通信的。啊，什么意思呢？就是rpc的这个呃，就是consumer这里边啊？它是怎么样啊？它是首先去连接的谁啊？

它首先连接的是zk。它首先连接的是zk啊，它连接完zk以后呢，它才拿到的，它所所想调用的这个服务rpc服务的。所在的IP地址端口，然后才来去连接这个。provider这个rpc服务节点的。明白吧啊就是这么一过程。好吧，跟我们之前点对点不同的是，就是说rpc节点呢？啊向zk发布服务r。rpc的调用方呢？从zk上呢？

找到服务所在的rpc。节点的IP地址端口号就完成这么一件事情zk在这里边儿就是作为一个服务的注册服务，发现的这么。一个中心的啊，好吧。啊，分布式。这个一一。呃，分布式协调的这个。它主要就做了分布式协调，服务协调啊，分布式环境中出现的所有问题。那就是我发布服务，我调用服务，

我调用的时候我不知道服务在哪儿哎，那咱们是不分布式环境中不同的？节点，那我们就要协调一下啊zoo在这里边儿，它就能做分布式的协调服务。啊，其中功能之一就是。rpc服务的这么一个。注册中心。好的吧啊，在这里边儿呢。呃，我们写完zk的话给大家也用了啊，用了以后呢，也给大家去演示了一下，

调用是非常OK的。也在这里边儿，也给大家验证了一下呢，我们zk的客户端，人家是可以定期的发送这个心跳消息的。给大家纠正这么一个错误好吧。那么至此呢我们？整个的基于啊。model库加port buffer的mpr PC。分布式网络通信框架的代码呢？就全部完成了啊。前面儿呢，我们带着大家呢，是一行一行码出来的啊。到最后了zk这里边儿呢。

把核心思想搞清楚，这块儿的代码呢，我就给大家。这样呢，直接写好了啊，就不带着一行一行去写了。好吧啊，因为这跟这块儿的代码呢？需要你了解一些东西和大家。可以先去网上多查一查资料啊，或者有问题问我也行。啊，逐渐的把它去搞明白好不好啊？最重要的是它。就是从这个理论上啊，

它为什么要应用在我们的这个？项目当中好不好啊？那我们这个项目开发的功能还是挺多的啊，也是。呃，有这个日志。对吧啊，写日志的这个异步的这个缓冲队列。啊，还有对于pro to buffer的这个深入的一个理解啊，它在分布式网络通信环境中是怎么去做数据的序列化跟反序？的话，又是怎么去规定一个rpc方法？啊的一个就是一个调用的这么一个约定的，对不对啊？

呃，然后就是对于这个。rpc通信原理的这么一个深入的这个了解啊，后边儿呢，我会给大家专门去总结的啊。呃，再者就是什么呀？再者，就是对于整个项目的一个。一个全局性的认识啊。我为什么要做这个项目？对不对啊？那因为我在做集群的时候，我发现了集群有。哪些需要弥补的地方，

不好的地方，这就是我们课程最前边儿开始讲的。啊，分布式相对于局情来说呢，它分布式部署有。哪些它的好处对不对？还是有很多的啊？那要解决分布式。呃的这个通信问题，我们需要一个框架。啊，来给我们把底层的这个rpc调用的详细过程全部。这就是我们去输出这个框架项目的。核心的原因对吧啊？呃，

这个项目整体来说呢，难度还是有一些的，希望大家呢。去看去写的时候呢。再去好好的去理解一下，有任何问题的话，大家可以在QQ上向我来发起这个问题啊。看到的话呢，我会给大家进行一个及时的回复。OK吧啊好，那这节课的内容就给大家先说到这里。